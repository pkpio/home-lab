version: '3'
services:
  #======================= Home Assistant =====================#
  # Hosts home-assistant instance
  #============================================================#
  home-assistant:
    container_name: home-assistant
    image: homeassistant/home-assistant:stable
    restart: always
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./home-assistant/config/:/config
    network_mode: host


  #====================== Zigbee dongle =======================#
  # Runs deconz to support conbee ii usb zigbee dongle
  #============================================================#
  zigbee-app:
    container_name: zigbee-app
    image: marthoc/deconz:latest
    restart: always
    ports:
      - 8080:8080
      - 8443:8443
      - 5900:5900
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./zigbee-app/config:/root/.local/share/dresden-elektronik/deCONZ
    devices:
      - /dev/ttyACM0
    env_file:
      - zigbee-app/.env


  #====================== Media server ========================#
  # Runs Plex media server in docker. TODO: Setup to use 
  # graphic card for hardware accelarated transcoding.
  #============================================================#
  media-server:
    container_name: media-server
    image: plexinc/pms-docker:latest
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./media-server/config:/config
      - ./media-server/transcode:/transcode
      - ./media-server/data:/data/internal-hd
      - /media/external-hd:/data/external-hd
    env_file:
      - media-server/.env
    network_mode: host


  #======================== Local sync =========================#
  # Local sync moves data from Internal to External HD. Has a 
  # cron task setup using the cron-service to do this periodically.
  #=============================================================#
  local-sync:
    container_name: local-sync
    image: eeacms/rsync:latest
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./media-server/data:/data/internal-hd
      - /media/external-hd:/data/external-hd
    labels:
      ofelia.enabled: "true"

      # Sync every Sunday at 4 am
      ofelia.job-exec.archive-docker-volume.schedule: "0 4 * * 0" 
      ofelia.job-exec.archive-docker-volume.command: >
        rsync -arvP --remove-source-files \
          --exclude="downloads" \ 
          /data/internal-hd /data/external-hd


  #====================== Monitoring ========================#
  # Runs Glances to monitor the resources of the Host
  #============================================================#
  monitoring:
    container_name: monitoring
    image: nicolargo/glances:latest-alpine
    restart: unless-stopped
    pid: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /media/external-hd:/external-hd:ro
    environment:
      - "GLANCES_OPT=-w"
    network_mode: host


  #======================== Cron service ======================#
  # Schedules cron jobs on different docker containers or host
  #============================================================#
  cron-service:
    container_name: cron-service
    image: mcuadros/ofelia:latest
    restart: always
    command: daemon --docker
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro


  #=================== Backup & cloud sync ====================#
  # Creates backups and syncs them to a cloud service
  #============================================================#
  cloud-backup:
    container_name: cloud-backup
    image: rclone/rclone:latest
    restart: always
    command: rcd --rc-web-gui --rc-addr :5572
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./cloud-backup/config:/config/rclone
      - ./cloud-backup/script:/script
      - ./cloud-backup/backups:/backups
      - ./:/all-containers-data:ro
    labels:
      ofelia.enabled: "true"

      # Create an archive at 2 am every day
      ofelia.job-exec.archive-docker-volume.schedule: "0 0 2 * * *" 
      ofelia.job-exec.archive-docker-volume.command: "/bin/sh -c /script/backup.sh"

      # Sync to cloud service at 3 am every day
      ofelia.job-exec.cloud-sync.schedule: "0 0 3 * * *" 
      ofelia.job-exec.cloud-sync.command: "rclone sync /backups cloud:/Home-Assistance-Backups"


  #===================== Torrent client =======================#
  # Runs tranmission torrent client through an OpenVPN tunnel
  #============================================================#
  torrent-client:
    container_name: torrent-client
    image: haugene/transmission-openvpn:latest
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    dns:
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./torrent-client/data:/data
      - ./media-server/data:/internal-hd
    devices:
      - /dev/net/tun
    env_file:
      - torrent-client/.env
    network_mode: host

