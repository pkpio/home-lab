version: '3'
services:
  home-assistant:
    container_name: home-assistant
    image: homeassistant/raspberrypi4-homeassistant:stable
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./home-assistant/config/:/config
    restart: always
    network_mode: host

  # Schedules cron jobs on different docker containers or host
  cron:
    container_name: cron
    build: https://github.com/mcuadros/ofelia.git
    command: daemon --docker
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # Creates backups and syncs them to a cloud service
  cloud-backup:
    container_name: cloud-backup
    image: rclone/rclone:latest
    command: rcd --rc-web-gui --rc-addr :5572
    restart: always
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./cloud-backup/config/:/config/rclone
      - ./cloud-backup/script/:/script
      - ./cloud-backup/backups:/backups
      - ./:/all-containers-data:ro
    labels:
      ofelia.enabled: "true"

      # Create an archive at 2 am every day
      ofelia.job-exec.archive-docker-volume.schedule: "0 0 2 * * *" 
      ofelia.job-exec.archive-docker-volume.command: "/bin/sh -c /script/backup.sh"

      # Sync to cloud service at 3 am every day
      ofelia.job-exec.cloud-sync.schedule: "0 0 3 * * *" 
      ofelia.job-exec.cloud-sync.command: "rclone sync /backups cloud:/Home-Assistance-Backups"

  # Runs tranmission torrent client through an OpenVPN tunnel
  torrent-client:
    container_name: torrent-client
    image: haugene/transmission-openvpn:latest-armhf
    cap_add:
      - NET_ADMIN
    devices:
      - "/dev/net/tun"
    restart: always
    ports:
      - "9091:9091"
      - "8888:8888"
    dns:
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./torrent-client/transmission-home:/data
    env_file:
      - torrent-client/.env

  # Proxy to access the transmission client's API 
  torrent-api-proxy:
    container_name: torrent-api-proxy
    image: haugene/transmission-openvpn-proxy:latest-armhf
    links:
      - transmission-client
    ports:
      - "8080:8080"
    volumes:
      - /etc/localtime:/etc/localtime:ro
